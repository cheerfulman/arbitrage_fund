# 修改FastAPI服务默认端口配置

## 1. 问题分析

### 1.1 当前配置
- FastAPI服务当前使用固定端口8000
- 代码中硬编码了端口号

### 1.2 用户需求
- HTTP默认使用80端口
- HTTPS默认使用443端口
- 不需要从代码层面配置SSL证书
- 希望服务能够灵活配置端口

### 1.3 技术考虑
- 80和443是特权端口，需要root权限绑定
- Docker容器中可以以root用户运行，所以在容器环境中不是问题
- 建议使用环境变量来管理配置，提高灵活性

## 2. 解决方案

### 2.1 方案：使用环境变量配置
- 通过环境变量设置端口号
- 默认值：HTTP=80
- 保持代码的灵活性
- 不涉及HTTPS证书配置，让外部代理（如Nginx）处理HTTPS

## 3. 实施步骤

### 3.1 修改main.py文件
1. 导入os模块（如果尚未导入）
2. 从环境变量中读取端口配置
3. 设置默认值：HTTP=80
4. 修改uvicorn.run()调用

## 4. 具体修改

### 4.1 修改main.py文件

```python
if __name__ == '__main__':
    # 从环境变量读取端口配置，默认HTTP端口80
    port = int(os.getenv("PORT", "80"))
    
    logger.info(f"FastAPI服务准备启动，监听端口 {port}")
    # 启动FastAPI服务
    uvicorn.run(app, host="0.0.0.0", port=port)
    logger.info("FastAPI服务已启动")
```

## 5. 环境变量配置示例

### 5.1 HTTP配置
```env
# .env文件
PORT=80
```

### 5.2 自定义端口配置
```env
# .env文件
PORT=8000
```

## 6. 关于HTTPS的说明

### 6.1 推荐方案
- 在生产环境中，建议使用反向代理（如Nginx）来处理HTTPS
- 反向代理配置SSL证书，监听443端口
- 反向代理将请求转发到FastAPI服务（内部使用80端口）

### 6.2 优势
- 简化FastAPI代码，不需要处理SSL证书
- 反向代理可以提供更好的HTTPS性能和安全性
- 便于在同一服务器上部署多个服务

## 7. 预期效果

- 默认情况下，服务使用HTTP 80端口
- 可以通过环境变量覆盖默认端口
- 代码更加灵活，便于在不同环境中部署
- HTTPS由外部代理处理，不需要修改代码

## 8. 注意事项

- 80和443是特权端口，需要root权限绑定
- 在Docker容器中，这通常不是问题，因为容器可以以root用户运行
- 在本地开发环境中，可能需要使用sudo命令运行服务
- 建议在生产环境中使用反向代理（如Nginx）来处理HTTPS