# 在lof\_data.py中添加新的数据源函数

## 1. 问题分析

### 1.1 用户需求

* 在 `lof_data.py` 文件中新建一个函数 `fetch_product_data()`

* 修改 `merge_fund_data()` 函数，合并三个数据源（LOF、QDII 和新的 product 数据）

* 修改 `fetch_all_fund_data()` 函数，调用新的 `fetch_product_data()` 函数

### 1.2 技术分析

* 新数据源的 API URL: `https://www.jisilu.cn/data/qdii/qdii_list/C?___jsl=LST___t=1769673055043&rp=22&page=1`

* 这是一个获取 QDII 基金数据的 API，参数 `C` 可能表示某种类型的基金

* 需要模仿现有的 `fetch_qdii_data()` 函数来实现 `fetch_product_data()` 函数

* 需要修改 `merge_fund_data()` 函数，使其能够合并三个数据源

* 需要修改 `fetch_all_fund_data()` 函数，添加对新函数的调用

## 2. 解决方案

### 2.1 实现步骤

1. 在 `lof_data.py` 文件中添加 `fetch_product_data()` 函数
2. 修改 `merge_fund_data()` 函数，添加对第三个数据源的支持
3. 修改 `fetch_all_fund_data()` 函数，调用新的 `fetch_product_data()` 函数

### 2.2 具体实现

#### 2.2.1 添加 fetch\_product\_data() 函数

* 模仿 `fetch_qdii_data()` 函数的实现

* 使用用户提供的 curl 命令中的 URL 和请求头

* 处理可能的异常情况

#### 2.2.2 修改 merge\_fund\_data() 函数

* 修改函数签名，添加第三个参数 `product_data`

* 在函数内部添加对 `product_data` 的处理

* 确保所有三个数据源都能被正确合并

#### 2.2.3 修改 fetch\_all\_fund\_data() 函数

* 添加对 `fetch_product_data()` 函数的调用

* 修改对 `merge_fund_data()` 函数的调用，传入三个数据源

## 3. 实施步骤

1. 打开 `lof_data.py` 文件
2. 在 `fetch_qdii_data()` 函数后添加 `fetch_product_data()` 函数
3. 修改 `merge_fund_data()` 函数，添加对第三个数据源的支持
4. 修改 `fetch_all_fund_data()` 函数，调用新的 `fetch_product_data()` 函数
5. 保存修改后的文件

## 4. 具体修改

### 4.1 添加 fetch\_product\_data() 函数

```python
def fetch_product_data():
    url = 'https://www.jisilu.cn/data/qdii/qdii_list/C?___jsl=LST___t=1769673055043&rp=22&page=1'
    
    headers = {
        'accept': 'application/json, text/javascript, */*; q=0.01',
        'accept-language': 'en,zh-CN;q=0.9,zh;q=0.8,zh-TW;q=0.7',
        'priority': 'u=1, i',
        'referer': 'https://www.jisilu.cn/data/qdii/',
        'sec-ch-ua': '"Not(A:Brand";v="8", "Chromium";v="144", "Google Chrome";v="144"',
        'sec-ch-ua-mobile': '?0',
        'sec-ch-ua-platform': '"macOS"',
        'sec-fetch-dest': 'empty',
        'sec-fetch-mode': 'cors',
        'sec-fetch-site': 'same-origin',
        'user-agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/144.0.0.0 Safari/537.36',
        'x-requested-with': 'XMLHttpRequest'
    }
    
    cookies = {
        'kbzw__Session': 'uujg96a2vmodsijvd10b9bbe65',
        'HMACCOUNT': 'EAB3FAD68D80D2E8',
        'kbz_newcookie': '1',
        'Hm_lvt_164fe01b1433a19b507595a43bf58262': '1769672869',
        'Hm_lpvt_164fe01b1433a19b507595a43bf58262': '1769672937'
    }
    
    try:
        response = requests.get(url, headers=headers, cookies=cookies)
        response.raise_for_status()  # 检查请求是否成功
        return response.json()  # 返回JSON响应数据
    except requests.exceptions.RequestException as e:
        print(f'Product请求发生错误: {e}')
        return None
```

### 4.2 修改 merge\_fund\_data() 函数

```python
def merge_fund_data(lof_data, qdii_data, product_data):
    """
    合并LOF、QDII和Product基金数据
    
    Args:
        lof_data: LOF基金数据
        qdii_data: QDII基金数据
        product_data: Product基金数据
        
    Returns:
        合并后的数据，格式与原始数据相同
    """
    if not lof_data and not qdii_data:
        return product_data
    if not lof_data and not product_data:
        return qdii_data
    if not qdii_data and not product_data:
        return lof_data
    
    merged_data = {
        'page': 1,
        'total': 1,
        'records': 0,
        'rows': []
    }
    
    # 添加LOF基金数据
    if 'rows' in lof_data:
        merged_data['rows'].extend(lof_data['rows'])
    
    # 添加QDII基金数据
    if 'rows' in qdii_data:
        merged_data['rows'].extend(qdii_data['rows'])
    
    # 添加Product基金数据
    if 'rows' in product_data:
        merged_data['rows'].extend(product_data['rows'])
    
    # 更新记录数
    merged_data['records'] = len(merged_data['rows'])
    
    return merged_data
```

### 4.3 修改 fetch\_all\_fund\_data() 函数

```python
def fetch_all_fund_data():
    """
    获取所有基金数据，包括LOF、QDII和Product
    
    Returns:
        合并后的基金数据
    """
    # 获取LOF基金数据
    print('正在获取LOF基金数据...')
    lof_data = fetch_lof_data()
    
    # 获取QDII基金数据
    print('正在获取QDII基金数据...')
    qdii_data = fetch_qdii_data()
    
    # 获取Product基金数据
    print('正在获取Product基金数据...')
    product_data = fetch_product_data()
    
    # 合并数据
    print('正在合并数据...')
    return merge_fund_data(lof_data, qdii_data, product_data)
```

## 5. 预期效果

* 系统能够获取三种类型的基金数据：LOF、QDII 和 Product

* 所有数据能够被正确合并

* 系统能够正常运行，没有错误

## 6. 注意事项

* 确保 `fetch_product_data()` 函数的实现与 `fetch_qdii_data()` 函数类似

* 确保 `merge_fund_data()` 函数能够处理所有三个数据源

* 确保 `fetch_all_fund_data()` 函数调用了新的 `fetch_product_data()` 函数

* 处理可能的异常情况，确保系统的稳定性

