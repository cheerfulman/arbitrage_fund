# LOF基金套利分析系统

## 1. 项目背景

LOF（Listed Open-Ended Fund）基金是一种既可以在交易所上市交易，又可以向基金公司申购赎回的开放式基金。由于LOF基金同时存在场内交易价格和场外净值，当两者之间出现较大偏差时，就会产生套利机会。

本项目旨在构建一个自动化的LOF基金套利分析系统，通过定期获取LOF基金的场内交易数据和场外净值数据，结合AI分析技术，实时识别潜在的套利机会，并为投资者提供决策参考。

## 2. 主要功能

- **自动数据获取**：定时从外部数据源获取LOF基金的详细数据
- **AI智能分析**：通过Coze API对基金数据进行多维度分析，识别套利机会
- **数据存储**：将基金数据和分析结果持久化存储到MySQL数据库
- **RESTful API**：提供标准化的API接口，方便前端或其他系统调用
- **定时任务**：每天自动执行基金分析，无需人工干预
- **手动触发**：支持手动触发分析任务，获取最新分析结果

## 3. 技术栈

| 类别 | 技术/库 | 版本 | 用途 |
|------|---------|------|------|
| 后端框架 | FastAPI | - | 构建高性能RESTful API |
| 数据库 | MySQL | - | 数据持久化存储 |
| 数据库驱动 | mysql-connector-python | - | Python连接MySQL |
| 定时任务 | APScheduler | - | 执行定时分析任务 |
| AI接口 | cozepy | - | 调用Coze AI服务 |
| HTTP客户端 | requests | - | 网络请求，获取基金数据 |
| 容器化 | Docker + Docker Compose | - | 项目部署和环境管理 |
| 依赖管理 | pip + requirements.txt | - | 项目依赖管理 |
| 其他库 | pytz | - | 时区处理 |
|  | python-dotenv | - | 环境变量管理 |
|  | dataclasses | - | 数据结构定义 |

## 4. 架构设计

### 4.1 系统架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                      外部系统/前端                                  │
└─────────────────────┬───────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      FastAPI服务                                    │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                        API层                                 │  │
│  │  - /api/ai-analyses/{date}        # 获取指定日期AI分析结果    │  │
│  │  - /api/trigger-analysis           # 手动触发分析任务         │  │
│  └───────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                        业务逻辑层                             │  │
│  │  - 基金数据获取与处理（lof_data.py）                         │  │
│  │  - AI分析结果生成（coze_api.py）                             │  │
│  │  - 数据持久化（db_utils.py）                                 │  │
│  └───────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                        数据访问层                             │  │
│  │  - MySQL数据库连接与操作                                      │  │
│  └───────────────────────────────────────────────────────────────┘  │
└─────────────────────┬───────────────────────────────────────────────┘
                      │
┌─────────────────────┼───────────────────────────────────────────────┐
│                      外部依赖                                       │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                        数据源                                 │  │
│  │  - 集思录LOF基金数据API（https://www.jisilu.cn）              │  │
│  └───────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                        AI服务                                 │  │
│  │  - Coze API（https://www.coze.com）                           │  │
│  └───────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.2 核心流程

1. **数据获取**：系统定时从集思录API获取LOF基金的最新数据，包括基金基本信息、场内交易价格、场外净值、折溢价率等。
2. **数据处理**：对获取到的原始数据进行清洗、转换和结构化处理，生成标准化的LOF基金对象。
3. **AI分析**：将处理后的数据发送到Coze API，由AI模型进行多维度分析，识别潜在的套利机会。
4. **结果存储**：将基金数据和AI分析结果持久化存储到MySQL数据库中。
5. **API服务**：通过FastAPI提供RESTful接口，供外部系统查询分析结果。

## 5. 项目结构

```
arbitrage_fund/
├── __pycache__/                    # Python编译缓存文件
├── ai_fund/                        # AI相关功能目录
├── .idea/                          # IDE配置文件
├── .gitignore                      # Git忽略文件配置
├── Dockerfile                      # Docker镜像构建文件
├── README.md                       # 项目说明文档
├── coze_api.py                     # Coze API客户端实现
├── db_utils.py                     # 数据库操作工具类
├── docker-compose.yml              # Docker Compose配置文件
├── lof_data.py                     # LOF基金数据获取与处理
├── main.py                         # 项目主入口，FastAPI服务实现
├── notice_api.py                   # 通知API实现
└── requirements.txt                # 项目依赖列表
```

## 6. 使用说明

### 6.1 环境准备

1. **Python环境**：Python 3.11+
2. **数据库**：MySQL 5.7+
3. **Docker环境**（可选）：用于容器化部署

### 6.2 配置说明

创建`.env`文件，配置以下环境变量：

```env
# 数据库配置
DB_HOST=db
DB_PORT=3306
DB_NAME=arbitrage_fund
DB_USER=root
DB_PASSWORD=root

# Coze API配置
COZE_API_TOKEN=your_coze_api_token
COZE_BOT_ID=your_coze_bot_id

# 可选配置
# USER_ID=123456789
```

### 6.3 安装与运行

#### 6.3.1 本地运行

1. 安装依赖：
   ```bash
   pip install -r requirements.txt
   ```

2. 运行服务：
   ```bash
   python main.py
   ```

3. 访问API文档：
   ```
   http://localhost:8000/docs
   ```

#### 6.3.2 Docker部署

1. 构建并运行Docker容器：
   ```bash
   docker-compose up -d
   ```

2. 查看服务状态：
   ```bash
   docker-compose ps
   ```

3. 停止服务：
   ```bash
   docker-compose down
   ```

### 6.4 定时任务

系统默认每天早上9点自动执行基金分析任务。可以通过修改`main.py`中的定时任务配置来调整执行时间：

```python
# 每天早上9点执行
scheduler.add_job(run_analysis, 'cron', hour=9, minute=0)
```

## 7. API接口文档

### 7.1 接口概述

| 接口名称 | 请求URL | 请求方法 | 功能描述 |
|----------|---------|----------|----------|
| 获取AI分析结果 | /api/ai-analyses/{date} | GET | 获取指定日期的AI分析结果 |
| 手动触发分析任务 | /api/trigger-analysis | POST | 手动触发基金分析任务 |

### 7.2 详细接口文档

#### 7.2.1 获取AI分析结果

**接口名称**：获取AI分析结果

**请求URL**：`/api/ai-analyses/{date}`

**请求方法**：GET

**请求头**：
| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| Content-Type | string | 否 | 内容类型，默认application/json |

**请求参数**：
| 参数名 | 位置 | 类型 | 必填 | 说明 |
|--------|------|------|------|------|
| date | path | string | 是 | 日期，格式：YYYY-MM-DD，例如：2026-01-09 |

**响应格式**：

**成功响应**：
```json
{
  "status": "success",
  "date": "2026-01-20",
  "count": 2,
  "data": [
    {
      "data": "### 套利机会判断\n存在显著套利机会...",
      "title": "国投白银LOF(161226)",
      "fund_name": "国投白银LOF",
      "fund_code": "161226",
      "nav_dt": "2026-01-20",
      "estimate_value": "2.6135",
      "price": "3.590",
      "apply_status": "限100"
    },
    {
      "data": "### 套利机会判断\n存在套利机会...",
      "title": "纳指科技ETF(159509)",
      "fund_name": "纳指科技ETF",
      "fund_code": "159509",
      "nav_dt": "2026-01-20",
      "estimate_value": "1.8968",
      "price": "2.192",
      "apply_status": "开放申购"
    }
  ]
}
```

**失败响应**：
```json
{
  "detail": "日期格式错误，应为YYYY-MM-DD"
}
```

**错误码说明**：
| 状态码 | 错误信息 | 说明 |
|--------|----------|------|
| 400 | 日期格式错误，应为YYYY-MM-DD | 请求的日期格式不正确 |
| 500 | 服务器内部错误 | 服务器端处理出错 |

**接口调用注意事项**：
- 日期格式必须为YYYY-MM-DD，否则会返回400错误
- 该接口返回的AI分析结果为Markdown格式
- 建议在前端使用Markdown解析器渲染分析结果

#### 7.2.2 手动触发分析任务

**接口名称**：手动触发分析任务

**请求URL**：`/api/trigger-analysis`

**请求方法**：POST

**请求头**：
| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| Content-Type | string | 否 | 内容类型，默认application/json |

**请求参数**：无

**响应格式**：

**成功响应**：
```json
{
  "status": "success",
  "message": "分析任务已开始执行"
}
```

**失败响应**：
```json
{
  "detail": "服务器内部错误"
}
```

**错误码说明**：
| 状态码 | 错误信息 | 说明 |
|--------|----------|------|
| 500 | 服务器内部错误 | 服务器端处理出错 |

**接口调用注意事项**：
- 该接口为异步执行，调用后立即返回，分析任务在后台执行
- 建议不要频繁调用该接口，避免给服务器带来过大压力
- 分析任务执行时间取决于数据量和AI分析速度，一般需要1-5分钟

## 8. 核心功能模块

### 8.1 LOF基金数据获取与处理

**模块文件**：`lof_data.py`

**主要功能**：
- 从集思录API获取LOF基金数据
- 解析和处理基金数据，生成标准化的LOF基金对象
- 支持按折溢价率排序基金数据
- 提供基金数据的结构化输出

### 8.2 数据库操作

**模块文件**：`db_utils.py`

**主要功能**：
- 数据库连接与管理
- 基金数据的存储与查询
- AI分析结果的存储与查询
- 数据模型映射

### 8.3 Coze API客户端

**模块文件**：`coze_api.py`

**主要功能**：
- Coze API的封装与调用
- 发送消息并获取AI分析结果
- 处理AI分析结果，提取有用信息

### 8.4 通知功能

**模块文件**：`notice_api.py`

**主要功能**：
- 微信消息推送
- 企业微信消息推送
- 支持多种通知渠道

## 9. 数据结构

### 9.1 LOF基金数据结构

```python
@dataclass
class LOFFund:
    # 基本信息
    fund_id: str          # 基金代码
    fund_nm: str          # 基金名称
    price: str            # 现价
    pre_close: str        # 昨天价格
    price_dt: str         # 净值日期
    increase_rt: str      # 涨幅
    volume: str           # 当日成交（万）
    amount: str           # 场内份额（万份）
    amount_incr: str      # 场内新增（万份）
    fund_nav: str         # 基金净值
    estimate_value: str   # 实时估值
    discount_rt: str      # 折价率
    index_id: str         # 跟踪指数代码
    index_nm: str         # 跟踪指数
    index_increase_rt: str # 指数涨幅
    apply_fee: str        # 申购费
    apply_status: str     # 申购状态
    redeem_fee: str       # 赎回费
    redeem_status: str    # 赎回状态
    turnover_rt: str      # 换手率
```

### 9.2 AI分析结果数据结构

```python
@dataclass
class AIAnalysis:
    id: int               # 主键ID
    analysis_content: str # AI分析内容
    fund_name: str        # 基金名称
    fund_code: str        # 基金代码
    created_at: datetime  # 创建时间
    update_at: datetime   # 更新时间
    date: date            # 分析日期
```

## 10. 监控与维护

### 10.1 日志管理

系统使用Python内置的logging模块进行日志记录，日志级别为INFO，主要记录以下内容：
- 服务启动和停止信息
- 定时任务执行情况
- API调用记录
- 错误和异常信息

### 10.2 常见问题排查

1. **数据库连接失败**：
   - 检查数据库服务是否正常运行
   - 检查数据库配置是否正确
   - 检查网络连接是否正常

2. **Coze API调用失败**：
   - 检查API令牌是否有效
   - 检查Bot ID是否正确
   - 检查网络连接是否正常

3. **定时任务不执行**：
   - 检查APScheduler是否正常启动
   - 检查定时任务配置是否正确
   - 检查系统时间是否准确

## 11. 未来规划

1. **支持更多基金类型**：扩展系统，支持ETF、分级基金等其他类型的基金套利分析
2. **增强AI分析能力**：优化AI分析模型，提供更精准的套利建议
3. **添加可视化界面**：开发Web前端，提供基金数据和分析结果的可视化展示
4. **支持实时推送**：添加实时通知功能，当出现优质套利机会时立即通知用户
5. **历史数据分析**：增加历史数据分析功能，支持回溯查看过去的套利机会


**更新时间**：2026-01-20
**版本**：1.0.0


